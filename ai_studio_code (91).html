<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FROTISE PARTS SYSTEM</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Zoom Library -->
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

    <style>
        /* --- DESIGN TOKENS --- */
        :root {
            --brand-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --accent: #f59e0b;
            --promo: #db2777; /* Pink/Red for Promo */
            --text-dark: #1e293b;
            --bg-main: #f1f5f9;
            --stock-high-bg: #dcfce7; --stock-high-text: #15803d;
            --stock-low-bg: #ffedd5; --stock-low-text: #c2410c;
            --stock-zero-bg: #fee2e2; --stock-zero-text: #b91c1c;
        }

        body { background-color: var(--bg-main); font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom: 100px; }

        /* --- UI UTILS --- */
        .fw-800 { font-weight: 800; }
        .backdrop-blur { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }

        /* --- NEW BADGE (Flashing) --- */
        .badge-new-manual {
            background: linear-gradient(45deg, #ff0055, #ff5500);
            color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px;
            margin-left: 8px; vertical-align: middle; font-weight: 800; letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(255, 0, 85, 0.4); animation: softPulse 2s infinite;
        }
        @keyframes softPulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- PRICE STYLES --- */
        .price-original { text-decoration: line-through; color: #94a3b8; font-size: 0.9rem; margin-right: 5px; font-weight: 600; }
        .price-promo { color: var(--promo); font-weight: 800; font-size: 1.25rem; }
        .price-normal { color: var(--text-dark); font-weight: 800; font-size: 1.25rem; }

        /* --- IMAGE LIGHTBOX --- */
        #imageOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            cursor: zoom-out; animation: fadeIn 0.2s;
        }
        #fullImage { max-width: 100%; max-height: 90%; object-fit: contain; transition: transform 0.1s; }
        .close-hint { position: absolute; bottom: 40px; color: rgba(255,255,255,0.5); font-size: 0.85rem; pointer-events: none; width: 100%; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- LOGIN SECTION --- */
        #loginSection {
            height: 100vh; width: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--brand-bg); position: fixed; top: 0; left: 0; z-index: 9999;
        }
        .login-card {
            background: rgba(255,255,255,0.95); padding: 40px 30px; border-radius: 24px;
            width: 85%; max-width: 380px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .form-control { border-radius: 12px; padding: 12px 15px; border: 1px solid #e2e8f0; background: #f8fafc; }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2); background: white; }

        /* --- MAIN HEADER --- */
        .header-bg {
            background: var(--brand-bg); color: white; padding: 25px 20px 80px;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; position: relative;
        }
        .logout-btn {
            position: absolute; top: 20px; left: 20px;
            color: rgba(255,255,255,0.7); font-size: 1.3rem;
            background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 12px;
            border: none; backdrop-filter: blur(4px);
        }
        
        .radiator-icon { width: 56px; height: 56px; fill: white; margin-bottom: 10px; opacity: 1; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }

        /* --- SEARCH BAR --- */
        .search-card {
            margin-top: -60px; background: white; border-radius: 20px;
            padding: 25px 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            position: relative; z-index: 10;
        }
        .input-group-lg .input-group-text { background: transparent; border: none; padding-left: 20px; }
        .input-group-lg .form-control { font-size: 1.1rem; border: none; background: transparent; box-shadow: none; padding-left: 10px;}
        .search-wrapper { background: #f1f5f9; border-radius: 15px; display: flex; align-items: center; border: 1px solid transparent; transition: all 0.2s;}
        .search-wrapper:focus-within { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); }

        /* --- RESULT ITEM --- */
        .result-item {
            background: var(--card-bg); border-radius: 16px; margin-bottom: 12px;
            padding: 16px; border: 1px solid transparent;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            transition: all 0.15s; cursor: pointer; position: relative;
        }
        .result-item:active { transform: scale(0.98); background-color: #f8fafc; border-color: #e2e8f0; }

        .stock-tag { 
            font-size: 0.65rem; padding: 4px 10px; border-radius: 20px; 
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;
        }
        .bg-stock-high { background-color: var(--stock-high-bg); color: var(--stock-high-text); }
        .bg-stock-low { background-color: var(--stock-low-bg); color: var(--stock-low-text); }
        .bg-stock-zero { background-color: var(--stock-zero-bg); color: var(--stock-zero-text); }

        .part-code { color: #3b82f6; font-size: 0.9rem; font-weight: 800; letter-spacing: 0.5px;}
        .part-name { font-weight: 600; color: #64748b; font-size: 0.85rem; margin-top: 4px; line-height: 1.4; }
        
        .product-img-thumb {
            width: 70px; height: 70px; object-fit: cover; border-radius: 12px; 
            background: #f8fafc; mix-blend-mode: multiply; margin-left: 15px;
        }

        /* --- MODAL --- */
        .modal-content { border-radius: 24px; border: none; overflow: hidden; }
        .modal-header { border-bottom: none; padding: 15px 20px 0; background: white; }
        .modal-body { padding: 10px 25px 25px; text-align: center;}
        
        .modal-img-wrapper { 
            background: #f8fafc; border-radius: 16px; padding: 10px; margin-bottom: 20px;
            position: relative; overflow: hidden; 
        }
        .modal-img { width: 100%; max-height: 250px; object-fit: contain; border-radius: 8px; }

        .status-bar {
            background: #f8fafc; border-radius: 16px; padding: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- CART --- */
        .fab-cart {
            position: fixed; bottom: 25px; right: 25px;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white;
            width: 64px; height: 64px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.4);
            z-index: 9000; cursor: pointer; transition: transform 0.2s;
        }
        .fab-cart:active { transform: scale(0.9); }
        .cart-badge {
            position: absolute; top: 0; right: 0;
            background-color: #ef4444; color: white; border: 2px solid white;
            border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        .qty-control { display: flex; align-items: center; justify-content: center; gap: 0; background: #f1f5f9; border-radius: 50px; padding: 5px;}
        .qty-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; 
            background: white; color: var(--text-dark); font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.1s;
        }
        .qty-display { width: 50px; text-align: center; border: none; font-weight: 800; font-size: 1.1rem; background: transparent; }
        
        #loadingMsg { text-align:center; padding: 40px; color: #94a3b8; display: none; font-weight: 500;}
    </style>
</head>
<body>

    <!-- IMAGE OVERLAY -->
    <div id="imageOverlay" onclick="window.closeImageViewer()">
        <img id="fullImage" src="">
        <div class="close-hint">Tap to close</div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginSection">
        <div class="login-card animate__animated animate__fadeInUp">
            <div class="mb-4">
                <svg class="radiator-icon" viewBox="0 0 24 24" style="fill:#0f172a; width:70px; height:70px;">
                    <path d="M4 3h16a2 2 0 0 1 2 2v1h-20v-1a2 2 0 0 1 2-2z"/>
                    <path d="M2 7h20v12a2 2 0 0 1-2 2h-16a2 2 0 0 1-2-2v-12z" fill="none" stroke="#0f172a" stroke-width="2"/>
                    <path d="M5 7v12M8 7v12M11 7v12M14 7v12M17 7v12M20 7v12" stroke="#0f172a" stroke-width="1.5"/>
                    <rect x="6" y="9" width="12" height="8" rx="1" fill="#0f172a" opacity="0.1"/>
                </svg>
            </div>
            <h3 class="fw-800 mb-1" style="color: var(--text-dark); letter-spacing: -0.5px;">FROTISE</h3>
            <p class="text-muted mb-4 small fw-bold text-uppercase ls-1">Parts Ordering System</p>
            
            <div class="mb-3 text-start">
                <input type="text" id="loginId" class="form-control form-control-lg text-center fw-bold" placeholder="CODE">
            </div>
            <div class="mb-4 text-start">
                <input type="password" id="loginPass" class="form-control form-control-lg text-center fw-bold" placeholder="PASSWORD">
            </div>
            <button onclick="window.attemptLogin()" class="btn btn-dark btn-lg w-100 fw-bold py-3 rounded-4" style="background:#0f172a;">ENTER SYSTEM</button>
            <div id="loginError" class="text-danger mt-3 small fw-bold" style="display:none;">ACCESS DENIED</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display:none;">
        
        <div class="header-bg text-center">
            <a href="#" onclick="window.logout()" class="logout-btn"><i class="bi bi-box-arrow-right"></i></a>
            
            <svg class="radiator-icon" viewBox="0 0 24 24" style="opacity: 0.9;">
                <path d="M4 3h16a2 2 0 0 1 2 2v1h-20v-1a2 2 0 0 1 2-2z"/> 
                <rect x="2" y="7" width="20" height="14" rx="2" fill="none" stroke="white" stroke-width="2"/> 
                <line x1="6" y1="7" x2="6" y2="21" stroke="white" stroke-width="1" opacity="0.4"/>
                <line x1="10" y1="7" x2="10" y2="21" stroke="white" stroke-width="1" opacity="0.4"/>
                <line x1="14" y1="7" x2="14" y2="21" stroke="white" stroke-width="1" opacity="0.4"/>
                <line x1="18" y1="7" x2="18" y2="21" stroke="white" stroke-width="1" opacity="0.4"/>
            </svg>

            <h3 class="fw-800 mb-0 ls-1">FROTISE</h3>
            <p class="opacity-50 small fw-bold ls-1 text-uppercase">Parts System</p>
            
            <div class="mt-2 badge bg-white bg-opacity-10 px-3 py-2 rounded-pill backdrop-blur">
                <span class="text-white-50 fw-normal">Welcome,</span> <span id="userDisplay" class="fw-bold text-white ms-1"></span>
            </div>
        </div>

        <div class="container">
            <div class="search-card">
                <div class="search-wrapper p-1">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-transparent border-0 ps-3"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-0 shadow-none" placeholder="Type 'NEW', 'STOCK' or Code..." onkeyup="window.handleSearch()">
                    </div>
                </div>
                <div class="text-center mt-2">
                    <span class="badge bg-light text-secondary rounded-pill px-3" id="totalCountBadge">Loading...</span>
                </div>
            </div>

            <div id="loadingMsg">Initializing database...</div>
            <div id="resultsList" class="mt-4 pb-4"></div>
        </div>

        <!-- Floating Cart -->
        <div class="fab-cart" onclick="window.openCartModal()">
            <i class="bi bi-bag-fill fs-4"></i>
            <div id="cartBadge" class="cart-badge" style="display: none;">0</div>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header">
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pt-0">
                    
                    <div class="modal-img-wrapper" onclick="window.viewImage(document.getElementById('modalImg').src)">
                        <img src="" id="modalImg" class="modal-img">
                        <div class="position-absolute bottom-0 end-0 m-2 px-2 py-1 bg-dark text-white rounded small fw-bold" style="opacity: 0.7; font-size: 0.6rem;">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center align-items-center mb-2">
                        <h2 class="fw-800 text-dark mb-0 ls-1" id="modalCode"></h2>
                        <div id="modalNewBadge" style="display:none;" class="ms-2 badge-new-manual">NEW</div>
                    </div>
                    
                    <p class="text-muted fw-bold small text-uppercase mb-4" id="modalName"></p>

                    <div class="status-bar">
                        <div class="text-start">
                            <span class="d-block text-muted text-uppercase" style="font-size:0.65rem; font-weight:700;">Price</span>
                            <div id="modalPriceContainer">
                                <!-- Price injected via JS -->
                            </div>
                        </div>
                        <div class="text-end">
                             <span class="d-block text-muted text-uppercase" style="font-size:0.65rem; font-weight:700;">Stock</span>
                            <div id="modalStockContent"></div>
                        </div>
                    </div>

                    <div id="addToCartSection">
                        <div class="d-flex justify-content-between align-items-center gap-3 mb-3">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="window.updateQty(-1)"><i class="bi bi-dash"></i></button>
                                <input type="number" id="qtyInput" class="qty-display" value="1" readonly>
                                <button class="qty-btn" onclick="window.updateQty(1)"><i class="bi bi-plus"></i></button>
                            </div>
                            <button onclick="window.addToCart()" class="btn btn-primary flex-grow-1 rounded-pill py-2 fw-bold" style="background: var(--brand-bg); border:none; height: 40px; box-shadow: 0 4px 15px rgba(30, 60, 114, 0.2);">
                                ADD TO CART
                            </button>
                        </div>
                    </div>
                    
                    <div id="outOfStockMsg" class="alert alert-danger mt-3 text-center" style="display:none;">
                        <i class="bi bi-slash-circle"></i> Currently Unavailable
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-800 ps-2">Your Selection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3" id="cartBody" style="background: #fcfcfc;"></div>
                <div class="modal-footer d-block bg-white border-0 pt-2 pb-4 px-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="text-muted small fw-bold text-uppercase">Total</span>
                        <span class="fs-2 fw-800 text-dark" id="cartTotal">0</span>
                    </div>
                    
                    <div id="limitWarning" class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger small fw-bold text-center mb-3" style="display:none;">
                         Limit exceeded (Max 100,000)
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button onclick="window.confirmOrder()" class="btn btn-success btn-lg rounded-pill fw-bold shadow-sm">
                            <i class="bi bi-whatsapp me-2"></i> Confirm & Send
                        </button>
                        <button onclick="window.downloadCSV()" class="btn btn-light btn-sm rounded-pill text-muted">
                            <i class="bi bi-filetype-csv me-1"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // CONFIG
        const currencyUnit = ""; 
        const myWhatsAppNumber = "233550584720"; 
        const orderLimit = 100000; 

        // ACCESS GROUPS
        // 1. Radiator & Cooling Group
        const ACCESS_COOLING = ["RADIATOR", "FAN CASE", "FAN BLADE", "CONDENSER"];
        // 2. Suspension A Group
        const ACCESS_SUSPENSION_A = ["SHOCK ABSORBER", "STABILIZER LINK", "TOP MOUNTING"];
        // 3. Mixed/Specific Group (GH98904)
        const ACCESS_MIXED_B = ["POWER STEERING RACK", "SHOCK ABSORBER", "CONTROL ARM"];
        // 4. Suspension Full Group (GH10112)
        const ACCESS_SUSPENSION_FULL = ["SHOCK ABSORBER", "IDLER ARM", "STABILIZER LINK", "BALL JOINT", "ARM BUSH", "RACK END", "CONTROL ROD", "TIE ROD END", "DRAG LINK", "CONTROL ARM"];

        // VALID USERS WITH PERMISSIONS
        const validUsers = [
            // Cooling Group
            { id: "GH10328", pass: "0000", name: "Yebford Radiator", access: ACCESS_COOLING },
            { id: "GH98791", pass: "0000", name: "K.auto", access: ACCESS_COOLING },
            { id: "GH10147", pass: "0000", name: "Qualiparts Ent", access: ACCESS_COOLING },
            { id: "GH10307", pass: "0000", name: "Yeboah Radiator", access: ACCESS_COOLING },
            { id: "GH98873", pass: "0000", name: "Pole to Pole", access: ACCESS_COOLING },
            { id: "GH10051", pass: "0000", name: "David Gyamfi", access: ACCESS_COOLING },
            
            // Suspension A
            { id: "GH10811", pass: "0000", name: "Client GH10811", access: ACCESS_SUSPENSION_A },

            // Suspension Full
            { id: "GH10112", pass: "0000", name: "Client GH10112", access: ACCESS_SUSPENSION_FULL },

            // Mixed Group
            { id: "GH98904", pass: "0000", name: "Client GH98904", access: ACCESS_MIXED_B }
        ];

        // STATE
        window.cart = [];
        window.currentItem = null;
        window.loggedInUser = null;
        window.productModal = null;
        window.cartModal = null;
        window.fullDatabase = []; // Holds everything loaded from CSV
        window.userDatabase = []; // Holds items filtered for logged-in user

        // INIT
        document.addEventListener('DOMContentLoaded', function() {
            window.productModal = new bootstrap.Modal(document.getElementById('productModal'));
            window.cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            loadDataFromCSV();
        });

        // LIGHTBOX
        window.viewImage = function(src) {
            if(!src || src.includes('placeholder')) return;
            document.getElementById('fullImage').src = src;
            document.getElementById('imageOverlay').style.display = 'flex';
        };
        window.closeImageViewer = function() { document.getElementById('imageOverlay').style.display = 'none'; };

        // CSV LOAD
        function loadDataFromCSV() {
            document.getElementById('loadingMsg').style.display = 'block';
            fetch('products.csv?v=' + Date.now())
                .then(r => { if(!r.ok) throw new Error("CSV not found"); return r.text(); })
                .then(t => {
                    const parsed = parseCSV(t);
                    window.fullDatabase = parsed;
                    document.getElementById('loadingMsg').style.display = 'none';
                })
                .catch(err => {
                    console.log(err);
                    // Demo data for testing
                    window.fullDatabase = [
                        {code:"1001", name:"RADIATOR TOYOTA", stock:50, price:100, promo:0, isNew:1},
                        {code:"1002", name:"SHOCK ABSORBER FRONT", stock:10, price:200, promo:150, isNew:0},
                        {code:"1003", name:"POWER STEERING RACK", stock:5, price:500, promo:0, isNew:1}
                    ];
                    document.getElementById('loadingMsg').style.display = 'none';
                });
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const data = [];
            // UPDATED CSV Format: Code, Name, Stock, Price, PromoPrice, NEW
            for(let i=1; i<lines.length; i++) {
                const l = lines[i].trim();
                if(!l) continue;
                const cols = l.split(',');
                
                if(cols.length >= 4) {
                    let promoVal = 0;
                    let isNewVal = 0;

                    // Check Promo (Col 4)
                    if(cols.length >= 5) {
                        const p = parseFloat(cols[4].trim());
                        if(!isNaN(p) && p > 0) promoVal = p;
                    }

                    // Check New (Col 5)
                    if(cols.length >= 6) {
                        isNewVal = (cols[5].trim() === '1') ? 1 : 0;
                    }

                    data.push({
                        code: cols[0].trim(),
                        name: cols[1].trim(),
                        stock: parseInt(cols[2].trim())||0,
                        price: parseFloat(cols[3].trim())||0,
                        promo: promoVal,
                        isNew: isNewVal
                    });
                }
            }
            return data;
        }

        // LOGIN AND FILTERING
        window.attemptLogin = function() {
            const i = document.getElementById('loginId').value.trim().toUpperCase();
            const p = document.getElementById('loginPass').value.trim();
            const user = validUsers.find(x => x.id === i && x.pass === p);
            
            if(user) {
                window.loggedInUser = user;
                // Filter Database based on User Access
                filterDatabaseForUser(user);
                
                document.getElementById('userDisplay').innerText = user.name;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                window.handleSearch();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        };

        function filterDatabaseForUser(user) {
            // Include item if its Name contains ANY of the allowed keywords
            window.userDatabase = window.fullDatabase.filter(item => {
                const upperName = item.name.toUpperCase();
                return user.access.some(keyword => upperName.includes(keyword));
            });
            document.getElementById('totalCountBadge').innerText = window.userDatabase.length + " ITEMS";
        }
        
        window.logout = function() { location.reload(); }

        // SEARCH
        window.handleSearch = function() {
            const val = document.getElementById('searchInput').value.toUpperCase().trim();
            const listDiv = document.getElementById('resultsList');
            
            // Search only within the filtered userDatabase
            let results = window.userDatabase;
            
            if(results.length === 0) {
                listDiv.innerHTML = `<div class="text-center text-muted mt-5 small">No authorized products found.</div>`;
                return;
            }

            if(val.length > 0) {
                if(val === 'STOCK') {
                    results = results.filter(i => i.stock > 0);
                } 
                else if (val === 'NEW') {
                    results = results.filter(i => i.isNew === 1);
                }
                else {
                    const tokens = val.split(/\s+/);
                    results = results.filter(item => {
                        const str = (item.code + " " + item.name).toUpperCase();
                        return tokens.every(t => str.includes(t));
                    });
                }
            }

            if(results.length === 0) {
                listDiv.innerHTML = `<div class="text-center text-muted mt-5 small">No items match your search</div>`;
                return;
            }
            
            const renderData = results.slice(0, 60);
            let html = '';
            renderData.forEach(i => {
                // Find index in userDatabase to map clicks correctly
                const idx = window.userDatabase.indexOf(i);
                const imgSrc = `images/${i.code}.jpg`;
                
                let badgeClass = "", badgeText = "";
                if(i.stock <= 0) { badgeText="OUT OF STOCK"; badgeClass="bg-stock-zero"; }
                else if(i.stock <= 10) { badgeText="LOW STOCK"; badgeClass="bg-stock-low"; }
                else { badgeText="IN STOCK"; badgeClass="bg-stock-high"; }

                let newHtml = (i.isNew === 1) ? `<span class="badge-new-manual">NEW</span>` : "";

                // Price Logic
                let priceDisplay = "";
                if(i.promo > 0 && i.promo < i.price) {
                    priceDisplay = `
                        <span class="price-original">${currencyUnit}${i.price}</span>
                        <span class="price-promo">${currencyUnit}${i.promo}</span>
                    `;
                } else {
                    priceDisplay = `<span class="price-normal">${currencyUnit}${i.price}</span>`;
                }

                html += `
                <div class="result-item d-flex align-items-center bg-white rounded" onclick="window.openProduct(${idx})">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                             <div class="part-code">${i.code} ${newHtml}</div>
                             <span class="stock-tag ${badgeClass}">${badgeText}</span>
                        </div>
                        <div class="part-name text-muted">${i.name}</div>
                        <div class="text-end mt-1">${priceDisplay}</div>
                    </div>
                    <img src="${imgSrc}" class="product-img-thumb" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
                </div>`;
            });
            listDiv.innerHTML = html;
        }

        // OPEN MODAL
        window.openProduct = function(idx) {
            window.currentItem = window.userDatabase[idx]; // Use userDatabase
            const d = window.currentItem;
            
            document.getElementById('modalCode').innerText = d.code;
            document.getElementById('modalName').innerText = d.name;
            document.getElementById('modalImg').src = `images/${d.code}.jpg`;
            document.getElementById('qtyInput').value = 1;

            // Price Display in Modal
            const pCont = document.getElementById('modalPriceContainer');
            if(d.promo > 0 && d.promo < d.price) {
                pCont.innerHTML = `
                    <span class="price-original fs-5">${currencyUnit}${d.price}</span>
                    <span class="price-promo fs-2">${currencyUnit}${d.promo}</span>
                `;
            } else {
                pCont.innerHTML = `<span class="price-normal fs-2">${currencyUnit}${d.price}</span>`;
            }

            // New Badge
            const newBadge = document.getElementById('modalNewBadge');
            newBadge.style.display = (d.isNew === 1) ? 'inline-block' : 'none';

            const stockBox = document.getElementById('modalStockContent');
            const addSec = document.getElementById('addToCartSection');
            const outSec = document.getElementById('outOfStockMsg');

            if(d.stock <= 0) {
                stockBox.innerHTML = `<span class="stock-tag bg-stock-zero">OUT OF STOCK</span>`;
                addSec.style.display = 'none';
                outSec.style.display = 'block';
            } else {
                addSec.style.display = 'block';
                outSec.style.display = 'none';
                if(d.stock <= 10) stockBox.innerHTML = `<span class="stock-tag bg-stock-low text-dark">LOW STOCK</span>`;
                else stockBox.innerHTML = `<span class="stock-tag bg-stock-high">IN STOCK</span>`;
            }
            
            window.productModal.show();
        };

        // CART ACTIONS
        window.updateQty = function(delta) {
            const inp = document.getElementById('qtyInput');
            let v = parseInt(inp.value) + delta;
            if(v<1) v=1;
            if(v > window.currentItem.stock) { alert("Stock limit reached"); v=window.currentItem.stock; }
            inp.value = v;
        }

        window.addToCart = function() {
            const qty = parseInt(document.getElementById('qtyInput').value);
            const item = window.currentItem;
            // Determine effective price
            const effectivePrice = (item.promo > 0 && item.promo < item.price) ? item.promo : item.price;

            const exist = window.cart.find(x => x.code === item.code);
            
            if(exist) {
                if(exist.qty + qty > item.stock) return alert("Stock limit exceeded");
                exist.qty += qty;
                // Update price just in case it changed
                exist.price = effectivePrice; 
            } else {
                window.cart.push({...item, qty: qty, price: effectivePrice});
            }
            window.productModal.hide();
            updateCartBadge();
        }

        function updateCartBadge() {
            const c = window.cart.reduce((a,b)=>a+b.qty,0);
            const b = document.getElementById('cartBadge');
            b.innerText = c;
            b.style.display = c>0?'flex':'none';
        }

        window.openCartModal = function() {
            const b = document.getElementById('cartBody');
            b.innerHTML = '';
            let total = 0;

            if(window.cart.length === 0) {
                b.innerHTML = `<div class="text-center py-5 text-muted opacity-50">Cart is empty</div>`;
            } else {
                window.cart.forEach((it,i) => {
                    const itemTotal = it.price * it.qty;
                    total += itemTotal;
                    
                    // Check if it's a promo price for visual indication in cart
                    const dbItem = window.fullDatabase.find(x => x.code === it.code);
                    let priceClass = "text-danger"; // Default red for price
                    if(dbItem && dbItem.promo > 0 && dbItem.promo == it.price) {
                        priceClass = "text-primary"; // Or distinct color for promo in cart
                    }

                    b.innerHTML += `
                    <div class="card mb-2 border-0 shadow-sm">
                        <div class="card-body p-3 d-flex justify-content-between align-items-center">
                            <div style="width:50%">
                                <div class="fw-bold text-dark">${it.code}</div>
                                <div class="small text-truncate text-muted">${it.name}</div>
                                <div class="${priceClass} fw-bold mt-1">${currencyUnit}${it.price}</div>
                            </div>
                            
                            <div class="text-end">
                                <div class="qty-control mb-2 justify-content-end">
                                    <button class="qty-btn p-0" onclick="window.changeCartQty(${i}, -1)">-</button>
                                    <span class="mx-2 fw-bold">${it.qty}</span>
                                    <button class="qty-btn p-0" onclick="window.changeCartQty(${i}, 1)">+</button>
                                </div>
                                <small class="text-danger fw-bold cursor-pointer" onclick="window.remCart(${i})">REMOVE</small>
                            </div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('cartTotal').innerText = currencyUnit + total;
            document.getElementById('limitWarning').style.display = total > orderLimit ? 'block':'none';
            window.cartModal.show();
        }

        window.changeCartQty = function(i, d) {
            const cItem = window.cart[i];
            const dbItem = window.fullDatabase.find(x=>x.code === cItem.code);
            let n = cItem.qty + d;
            if(n < 1) return;
            if(n > dbItem.stock) return alert("Stock Limit");
            cItem.qty = n;
            window.openCartModal();
            updateCartBadge();
        }

        window.remCart = function(i) {
            window.cart.splice(i, 1);
            window.openCartModal();
            updateCartBadge();
        }

        window.confirmOrder = function() {
            if(window.cart.length===0) return alert("Empty Cart");
            const t = window.cart.reduce((a,b)=>a+b.price*b.qty,0);
            if(t > orderLimit) return alert("Over 100,000 Limit");
            
            // Local deduct
            window.cart.forEach(c => {
                let d = window.fullDatabase.find(x=>x.code === c.code);
                if(d) d.stock = Math.max(0, d.stock - c.qty);
            });

            let m = `ðŸ›’ *ORDER (${window.loggedInUser.name})*\n`;
            window.cart.forEach(x => m+=`â–ª ${x.code} (x${x.qty}) - ${x.price}\n`);
            m += `TOTAL: ${t}`;
            
            window.open(`https://wa.me/${myWhatsAppNumber}?text=${encodeURIComponent(m)}`, '_blank');
            
            window.cart=[]; 
            updateCartBadge(); 
            window.cartModal.hide();
            window.handleSearch();
        }

        window.downloadCSV = function() {
             if(window.cart.length===0) return alert("Empty");
             let c = "Client,Code,Qty,Price,Total\n";
             window.cart.forEach(x => c+=`${window.loggedInUser.name},${x.code},${x.qty},${x.price},${x.price*x.qty}\n`);
             const a = document.createElement('a');
             a.href = 'data:text/csv;charset=utf-8,' + encodeURI(c);
             a.download = 'order.csv';
             a.click();
        }
        
        document.getElementById('loginPass').addEventListener('keypress', (e)=>{
            if(e.key==='Enter') window.attemptLogin();
        });
    </script>
</body>
</html>
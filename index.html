<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FROTISE PARTS SYSTEM</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Zoom Library -->
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

    <style>
        /* --- BRANDING & DESIGN TOKENS --- */
        :root {
            /* Frotise Blue Theme */
            --brand-primary: #0056b3; /* Based on logo blue */
            --brand-dark: #003d80;
            --brand-bg: linear-gradient(180deg, #0056b3 0%, #003d80 100%);
            
            --accent: #ffcc00; /* Yellow accent for contrast if needed */
            --promo: #dc3545; /* Red for Promo */
            --text-dark: #1e293b;
            --bg-main: #f8f9fa;
            
            --stock-high-bg: #dcfce7; --stock-high-text: #15803d;
            --stock-low-bg: #ffedd5; --stock-low-text: #c2410c;
            --stock-zero-bg: #fee2e2; --stock-zero-text: #b91c1c;
        }

        body { background-color: var(--bg-main); font-family: "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom: 100px; }

        /* --- UI UTILS --- */
        .fw-800 { font-weight: 800; }
        .backdrop-blur { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .text-brand { color: var(--brand-primary); }

        /* --- NEW BADGE (Flashing) --- */
        .badge-new-manual {
            background: linear-gradient(45deg, #0d6efd, #0a58ca);
            color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px;
            margin-left: 8px; vertical-align: middle; font-weight: 800; letter-spacing: 1px;
        }

        /* --- PRICE STYLES --- */
        .price-original { text-decoration: line-through; color: #94a3b8; font-size: 0.85rem; margin-right: 5px; font-weight: 600; }
        .price-promo { color: var(--promo); font-weight: 800; font-size: 1.15rem; }
        .price-normal { color: var(--text-dark); font-weight: 800; font-size: 1.15rem; }
        .moq-tag { font-size: 0.6rem; background: #fee2e2; color: #b91c1c; padding: 2px 4px; border-radius: 4px; font-weight: bold; margin-left: 5px; vertical-align: middle; }

        /* --- IMAGE LIGHTBOX --- */
        #imageOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 10000;
            display: none; justify-content: center; align-items: center;
            cursor: zoom-out; animation: fadeIn 0.2s;
        }
        #fullImage { max-width: 100%; max-height: 90%; object-fit: contain; transition: transform 0.1s; }
        .close-hint { position: absolute; bottom: 40px; color: rgba(255,255,255,0.5); font-size: 0.85rem; pointer-events: none; width: 100%; text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- LOGIN SECTION --- */
        #loginSection {
            height: 100vh; width: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: white; /* Clean white background for login with blue logo */
            position: fixed; top: 0; left: 0; z-index: 9999;
        }
        .login-logo { max-width: 260px; margin-bottom: 20px; }
        
        .login-card {
            background: #fff; padding: 30px; border-radius: 20px;
            width: 85%; max-width: 380px; text-align: center;
        }
        .form-control { border-radius: 12px; padding: 12px 15px; border: 2px solid #e2e8f0; background: #f8fafc; font-weight: 600; }
        .form-control:focus { border-color: var(--brand-primary); box-shadow: none; background: white; }

        /* --- MAIN HEADER --- */
        .header-bg {
            background: var(--brand-bg);
            color: white; padding: 25px 20px 80px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            position: relative;
            box-shadow: 0 10px 30px -10px rgba(0, 86, 179, 0.5);
        }
        .logout-btn {
            position: absolute; top: 20px; left: 20px;
            color: rgba(255,255,255,0.8); font-size: 1.3rem;
            background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 12px;
            border: none; backdrop-filter: blur(4px);
        }
        
        .header-logo { height: 45px; width: auto; margin-bottom: 10px; filter: brightness(0) invert(1); /* Makes logo white if it's transparent PNG */ }
        /* Note: If your logo is a JPG with white background, remove the filter above and use a white container or just let it be boxy */

        /* --- SEARCH BAR --- */
        .search-card {
            margin-top: -60px; background: white; border-radius: 20px;
            padding: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.08);
            position: relative; z-index: 10;
        }
        .search-wrapper { background: #f1f5f9; border-radius: 12px; display: flex; align-items: center; border: 1px solid #e2e8f0; }
        .search-wrapper:focus-within { border-color: var(--brand-primary); background: white; }

        /* --- RESULT ITEM (No Image in List) --- */
        .result-item {
            background: white; border-radius: 12px; margin-bottom: 10px;
            padding: 18px 20px; border: 1px solid #f1f5f9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            transition: all 0.1s; cursor: pointer; position: relative;
        }
        .result-item:active { transform: scale(0.98); background-color: #f8fafc; border-color: var(--brand-primary); }

        .stock-tag { 
            font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; 
            font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block;
        }
        .bg-stock-high { background-color: var(--stock-high-bg); color: var(--stock-high-text); }
        .bg-stock-low { background-color: var(--stock-low-bg); color: var(--stock-low-text); }
        .bg-stock-zero { background-color: var(--stock-zero-bg); color: var(--stock-zero-text); }

        .part-code { color: var(--brand-primary); font-size: 1rem; font-weight: 800; letter-spacing: 0.5px;}
        .part-name { font-weight: 600; color: #64748b; font-size: 0.9rem; margin-top: 4px; }
        
        /* --- MODAL --- */
        .modal-content { border-radius: 24px; border: none; overflow: hidden; }
        .modal-header { border-bottom: none; padding: 15px 20px 0; background: white; }
        .modal-body { padding: 10px 25px 25px; text-align: center;}
        
        .modal-img-wrapper { 
            background: #f8fafc; border-radius: 16px; padding: 20px; margin-bottom: 20px;
            position: relative; overflow: hidden; min-height: 200px; display: flex; align-items: center; justify-content: center;
        }
        .modal-img { width: 100%; max-height: 250px; object-fit: contain; }

        .status-bar {
            background: #f8fafc; border-radius: 12px; padding: 15px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #e2e8f0;
        }

        /* --- CART --- */
        .fab-cart {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--brand-primary); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0, 86, 179, 0.4);
            z-index: 9000; cursor: pointer; transition: transform 0.2s;
        }
        .fab-cart:active { transform: scale(0.9); }
        .cart-badge {
            position: absolute; top: -2px; right: -2px;
            background-color: var(--promo); color: white; border: 2px solid white;
            border-radius: 50%; width: 24px; height: 24px;
            font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        .qty-control { display: flex; align-items: center; justify-content: center; gap: 0; background: #f1f5f9; border-radius: 50px; padding: 4px;}
        .qty-btn { 
            width: 36px; height: 36px; border-radius: 50%; border: none; 
            background: white; color: var(--text-dark); font-size: 1.2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.1s;
        }
        .qty-display { width: 45px; text-align: center; border: none; font-weight: 800; font-size: 1.1rem; background: transparent; }
        
        #loadingMsg { text-align:center; padding: 40px; color: #94a3b8; display: none; font-weight: 500;}
        
        .promo-hint { font-size: 0.7rem; color: var(--promo); font-weight: bold; display: block; margin-top: 2px;}
    </style>
</head>
<body>

    <!-- IMAGE OVERLAY -->
    <div id="imageOverlay" onclick="window.closeImageViewer()">
        <img id="fullImage" src="">
        <div class="close-hint">Tap to close</div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginSection">
        <!-- REPLACED ICON WITH LOGO IMAGE -->
        <!-- Make sure logo.png exists in your folder -->
        <img src="logo.png" alt="FROTISE" class="login-logo animate__animated animate__fadeInDown">
        
        <div class="login-card animate__animated animate__fadeInUp">
            <h4 class="fw-800 mb-1 text-brand ls-1">PARTNER ACCESS</h4>
            <p class="text-muted mb-4 small fw-bold text-uppercase">Parts Ordering System</p>
            
            <div class="mb-3 text-start">
                <input type="text" id="loginId" class="form-control form-control-lg text-center" placeholder="ENTER ID CODE">
            </div>
            <div class="mb-4 text-start">
                <input type="password" id="loginPass" class="form-control form-control-lg text-center" placeholder="PASSWORD">
            </div>
            <button onclick="window.attemptLogin()" class="btn btn-primary btn-lg w-100 fw-bold py-3 rounded-3" style="background-color: var(--brand-primary); border:none;">LOGIN</button>
            <div id="loginError" class="text-danger mt-3 small fw-bold" style="display:none;">ACCESS DENIED</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display:none;">
        
        <div class="header-bg text-center">
            <a href="#" onclick="window.logout()" class="logout-btn"><i class="bi bi-box-arrow-right"></i></a>
            
            <!-- REPLACED ICON WITH LOGO IMAGE (White version filter applied via CSS) -->
            <img src="logo.png" alt="FROTISE" class="header-logo">

            <div class="mt-1 badge bg-white bg-opacity-20 px-3 py-1 rounded-pill backdrop-blur">
                <span class="text-white-50 fw-normal small">User:</span> <span id="userDisplay" class="fw-bold text-white ms-1 small"></span>
            </div>
        </div>

        <div class="container">
            <div class="search-card">
                <div class="search-wrapper p-1">
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-transparent border-0 ps-3"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-0 shadow-none" placeholder="Search Part No. or Name..." onkeyup="window.handleSearch()">
                    </div>
                </div>
                <div class="text-center mt-2 d-flex justify-content-center gap-2">
                    <button class="btn btn-sm btn-light rounded-pill px-3 fw-bold text-secondary" onclick="window.setSearchToNew()">NEW ITEMS</button>
                    <span class="badge bg-light text-secondary rounded-pill px-3 pt-2" id="totalCountBadge">...</span>
                </div>
            </div>

            <div id="loadingMsg">Syncing database...</div>
            <div id="resultsList" class="mt-4 pb-4"></div>
        </div>

        <!-- Floating Cart -->
        <div class="fab-cart" onclick="window.openCartModal()">
            <i class="bi bi-cart-fill fs-4"></i>
            <div id="cartBadge" class="cart-badge" style="display: none;">0</div>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header">
                    <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pt-0">
                    
                    <!-- Image ONLY appears here now -->
                    <div class="modal-img-wrapper" onclick="window.viewImage(document.getElementById('modalImg').src)">
                        <img src="" id="modalImg" class="modal-img">
                        <div class="position-absolute bottom-0 end-0 m-2 px-2 py-1 bg-dark text-white rounded small fw-bold" style="opacity: 0.7; font-size: 0.6rem;">
                            <i class="bi bi-zoom-in"></i>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center align-items-center mb-2">
                        <h2 class="fw-800 text-dark mb-0 ls-1" id="modalCode"></h2>
                        <div id="modalNewBadge" style="display:none;" class="ms-2 badge-new-manual">NEW</div>
                    </div>
                    
                    <p class="text-muted fw-bold small text-uppercase mb-4" id="modalName"></p>

                    <div class="status-bar">
                        <div class="text-start">
                            <span class="d-block text-muted text-uppercase" style="font-size:0.65rem; font-weight:700;">Unit Price</span>
                            <div id="modalPriceContainer">
                                <!-- Price injected via JS -->
                            </div>
                        </div>
                        <div class="text-end">
                             <span class="d-block text-muted text-uppercase" style="font-size:0.65rem; font-weight:700;">Availability</span>
                            <div id="modalStockContent"></div>
                        </div>
                    </div>
                    
                    <div id="promoNotice" class="alert alert-warning py-2 small fw-bold mb-3" style="display:none; color: #854d0e; background: #fef9c3; border:none;">
                        <i class="bi bi-info-circle-fill me-1"></i> Add 5+ items to unlock Promo Price
                    </div>

                    <div id="addToCartSection">
                        <div class="d-flex justify-content-between align-items-center gap-3 mb-3">
                            <div class="qty-control">
                                <button class="qty-btn" onclick="window.updateQty(-1)"><i class="bi bi-dash"></i></button>
                                <input type="number" id="qtyInput" class="qty-display" value="1" readonly>
                                <button class="qty-btn" onclick="window.updateQty(1)"><i class="bi bi-plus"></i></button>
                            </div>
                            <button onclick="window.addToCart()" class="btn btn-primary flex-grow-1 rounded-pill py-2 fw-bold" style="background-color: var(--brand-primary); border:none; height: 45px; box-shadow: 0 4px 15px rgba(0, 86, 179, 0.2);">
                                ADD TO CART
                            </button>
                        </div>
                    </div>
                    
                    <div id="outOfStockMsg" class="alert alert-danger mt-3 text-center" style="display:none;">
                        <i class="bi bi-slash-circle"></i> Currently Unavailable
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CART MODAL -->
    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-800 ps-2 text-brand">Your Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3" id="cartBody" style="background: #fff;"></div>
                <div class="modal-footer d-block bg-white border-0 pt-2 pb-4 px-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="text-muted small fw-bold text-uppercase">Total</span>
                        <span class="fs-2 fw-800 text-dark" id="cartTotal">0</span>
                    </div>
                    
                    <div id="limitWarning" class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger small fw-bold text-center mb-3" style="display:none;">
                         Limit exceeded (Max 100,000)
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button onclick="window.confirmOrder()" class="btn btn-success btn-lg rounded-pill fw-bold shadow-sm" style="background-color: #25D366; border:none;">
                            <i class="bi bi-whatsapp me-2"></i> Submit Order
                        </button>
                        <button onclick="window.downloadCSV()" class="btn btn-light btn-sm rounded-pill text-muted">
                            <i class="bi bi-filetype-csv me-1"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // CONFIG
        const currencyUnit = ""; 
        const myWhatsAppNumber = "233550584720"; 
        const orderLimit = 100000; 

        // ACCESS GROUPS
        const ACCESS_COOLING = ["RADIATOR", "FAN CASE", "FAN BLADE", "CONDENSER"];
        const ACCESS_SUSPENSION_A = ["SHOCK ABSORBER", "STABILIZER LINK", "TOP MOUNTING"];
        const ACCESS_MIXED_B = ["POWER STEERING RACK", "SHOCK ABSORBER", "CONTROL ARM"];
        const ACCESS_SUSPENSION_FULL = ["SHOCK ABSORBER", "IDLER ARM", "STABILIZER LINK", "BALL JOINT", "ARM BUSH", "RACK END", "CONTROL ROD", "TIE ROD END", "DRAG LINK", "CONTROL ARM"];

        // VALID USERS
        const validUsers = [
            { id: "GH10328", pass: "0000", name: "Yebford Radiator", access: ACCESS_COOLING },
            { id: "GH98791", pass: "0000", name: "K.auto", access: ACCESS_COOLING },
            { id: "GH10147", pass: "0000", name: "Qualiparts Ent", access: ACCESS_COOLING },
            { id: "GH10307", pass: "0000", name: "Yeboah Radiator", access: ACCESS_COOLING },
            { id: "GH98873", pass: "0000", name: "Pole to Pole", access: ACCESS_COOLING },
            { id: "GH10051", pass: "0000", name: "David Gyamfi", access: ACCESS_COOLING },
            { id: "GH10811", pass: "0000", name: "Client GH10811", access: ACCESS_SUSPENSION_A },
            { id: "GH10112", pass: "0000", name: "Client GH10112", access: ACCESS_SUSPENSION_FULL },
            { id: "GH98904", pass: "0000", name: "Client GH98904", access: ACCESS_MIXED_B }
        ];

        // STATE
        window.cart = [];
        window.currentItem = null;
        window.loggedInUser = null;
        window.productModal = null;
        window.cartModal = null;
        window.fullDatabase = []; 
        window.userDatabase = []; 

        // INIT
        document.addEventListener('DOMContentLoaded', function() {
            window.productModal = new bootstrap.Modal(document.getElementById('productModal'));
            window.cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
            loadDataFromCSV();
        });

        // LIGHTBOX
        window.viewImage = function(src) {
            if(!src || src.includes('placeholder')) return;
            document.getElementById('fullImage').src = src;
            document.getElementById('imageOverlay').style.display = 'flex';
        };
        window.closeImageViewer = function() { document.getElementById('imageOverlay').style.display = 'none'; };

        // SEARCH SHORTCUT
        window.setSearchToNew = function() {
            document.getElementById('searchInput').value = 'NEW';
            window.handleSearch();
        }

        // CSV LOAD
        function loadDataFromCSV() {
            document.getElementById('loadingMsg').style.display = 'block';
            fetch('products.csv?v=' + Date.now())
                .then(r => { if(!r.ok) throw new Error("CSV not found"); return r.text(); })
                .then(t => {
                    const parsed = parseCSV(t);
                    window.fullDatabase = parsed;
                    document.getElementById('loadingMsg').style.display = 'none';
                })
                .catch(err => {
                    console.log(err);
                    // Demo Fallback
                    window.fullDatabase = [
                        {code:"1001", name:"RADIATOR TOYOTA", stock:50, price:100, promo:0, isNew:1},
                        {code:"1002", name:"SHOCK ABSORBER FRONT", stock:10, price:200, promo:150, isNew:0},
                        {code:"1003", name:"POWER STEERING RACK", stock:5, price:500, promo:450, isNew:1}
                    ];
                    document.getElementById('loadingMsg').style.display = 'none';
                });
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const data = [];
            for(let i=1; i<lines.length; i++) {
                const l = lines[i].trim();
                if(!l) continue;
                const cols = l.split(',');
                if(cols.length >= 4) {
                    let promoVal = 0;
                    let isNewVal = 0;
                    if(cols.length >= 5) {
                        const p = parseFloat(cols[4].trim());
                        if(!isNaN(p) && p > 0) promoVal = p;
                    }
                    if(cols.length >= 6) {
                        isNewVal = (cols[5].trim() === '1') ? 1 : 0;
                    }
                    data.push({
                        code: cols[0].trim(),
                        name: cols[1].trim(),
                        stock: parseInt(cols[2].trim())||0,
                        price: parseFloat(cols[3].trim())||0,
                        promo: promoVal,
                        isNew: isNewVal
                    });
                }
            }
            return data;
        }

        // LOGIN
        window.attemptLogin = function() {
            const i = document.getElementById('loginId').value.trim().toUpperCase();
            const p = document.getElementById('loginPass').value.trim();
            const user = validUsers.find(x => x.id === i && x.pass === p);
            
            if(user) {
                window.loggedInUser = user;
                filterDatabaseForUser(user);
                document.getElementById('userDisplay').innerText = user.name;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                window.handleSearch();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        };

        function filterDatabaseForUser(user) {
            window.userDatabase = window.fullDatabase.filter(item => {
                const upperName = item.name.toUpperCase();
                return user.access.some(keyword => upperName.includes(keyword));
            });
            document.getElementById('totalCountBadge').innerText = window.userDatabase.length;
        }
        
        window.logout = function() { location.reload(); }

        // SEARCH - UPDATED (Removed Image from List)
        window.handleSearch = function() {
            const val = document.getElementById('searchInput').value.toUpperCase().trim();
            const listDiv = document.getElementById('resultsList');
            let results = window.userDatabase;
            
            if(results.length === 0) {
                listDiv.innerHTML = `<div class="text-center text-muted mt-5 small">No authorized products found.</div>`;
                return;
            }

            if(val.length > 0) {
                if(val === 'STOCK') { results = results.filter(i => i.stock > 0); } 
                else if (val === 'NEW') { results = results.filter(i => i.isNew === 1); }
                else {
                    const tokens = val.split(/\s+/);
                    results = results.filter(item => {
                        const str = (item.code + " " + item.name).toUpperCase();
                        return tokens.every(t => str.includes(t));
                    });
                }
            }

            if(results.length === 0) {
                listDiv.innerHTML = `<div class="text-center text-muted mt-5 small">No items match your search</div>`;
                return;
            }
            
            const renderData = results.slice(0, 60);
            let html = '';
            renderData.forEach(i => {
                const idx = window.userDatabase.indexOf(i);
                
                let badgeClass = "", badgeText = "";
                if(i.stock <= 0) { badgeText="OUT OF STOCK"; badgeClass="bg-stock-zero"; }
                else if(i.stock <= 10) { badgeText="LOW STOCK"; badgeClass="bg-stock-low"; }
                else { badgeText="IN STOCK"; badgeClass="bg-stock-high"; }

                let newHtml = (i.isNew === 1) ? `<span class="badge-new-manual">NEW</span>` : "";

                // Price Logic for List View (Shows potential promo)
                let priceDisplay = "";
                if(i.promo > 0 && i.promo < i.price) {
                    priceDisplay = `
                        <div>
                            <span class="price-original">${currencyUnit}${i.price}</span>
                            <span class="price-promo">${currencyUnit}${i.promo}</span>
                            <span class="moq-tag">MOQ:5</span>
                        </div>
                    `;
                } else {
                    priceDisplay = `<span class="price-normal">${currencyUnit}${i.price}</span>`;
                }

                // REMOVED <img> from here
                html += `
                <div class="result-item" onclick="window.openProduct(${idx})">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                            <div class="part-code">${i.code} ${newHtml}</div>
                            <span class="stock-tag ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <div class="part-name text-muted pe-2" style="max-width: 65%;">${i.name}</div>
                        <div class="text-end">${priceDisplay}</div>
                    </div>
                </div>`;
            });
            listDiv.innerHTML = html;
        }

        // OPEN MODAL
        window.openProduct = function(idx) {
            window.currentItem = window.userDatabase[idx];
            const d = window.currentItem;
            
            document.getElementById('modalCode').innerText = d.code;
            document.getElementById('modalName').innerText = d.name;
            document.getElementById('modalImg').src = `images/${d.code}.jpg`;
            document.getElementById('qtyInput').value = 1;

            // Price Display in Modal
            const pCont = document.getElementById('modalPriceContainer');
            const promoNotice = document.getElementById('promoNotice');
            
            if(d.promo > 0 && d.promo < d.price) {
                pCont.innerHTML = `
                    <span class="price-original fs-5">${currencyUnit}${d.price}</span>
                    <span class="price-promo fs-2">${currencyUnit}${d.promo}</span>
                `;
                promoNotice.style.display = 'block';
            } else {
                pCont.innerHTML = `<span class="price-normal fs-2">${currencyUnit}${d.price}</span>`;
                promoNotice.style.display = 'none';
            }

            const newBadge = document.getElementById('modalNewBadge');
            newBadge.style.display = (d.isNew === 1) ? 'inline-block' : 'none';

            const stockBox = document.getElementById('modalStockContent');
            const addSec = document.getElementById('addToCartSection');
            const outSec = document.getElementById('outOfStockMsg');

            if(d.stock <= 0) {
                stockBox.innerHTML = `<span class="stock-tag bg-stock-zero">OUT OF STOCK</span>`;
                addSec.style.display = 'none';
                outSec.style.display = 'block';
            } else {
                addSec.style.display = 'block';
                outSec.style.display = 'none';
                if(d.stock <= 10) stockBox.innerHTML = `<span class="stock-tag bg-stock-low text-dark">LOW STOCK</span>`;
                else stockBox.innerHTML = `<span class="stock-tag bg-stock-high">IN STOCK</span>`;
            }
            
            window.productModal.show();
        };

        // CART ACTIONS
        window.updateQty = function(delta) {
            const inp = document.getElementById('qtyInput');
            let v = parseInt(inp.value) + delta;
            if(v<1) v=1;
            if(v > window.currentItem.stock) { alert("Stock limit reached"); v=window.currentItem.stock; }
            inp.value = v;
        }

        window.addToCart = function() {
            const qty = parseInt(document.getElementById('qtyInput').value);
            const item = window.currentItem;
            
            const exist = window.cart.find(x => x.code === item.code);
            if(exist) {
                if(exist.qty + qty > item.stock) return alert("Stock limit exceeded");
                exist.qty += qty;
            } else {
                // Store base info. Price logic happens in Cart Render.
                window.cart.push({...item, qty: qty});
            }
            window.productModal.hide();
            updateCartBadge();
        }

        function updateCartBadge() {
            const c = window.cart.reduce((a,b)=>a+b.qty,0);
            const b = document.getElementById('cartBadge');
            b.innerText = c;
            b.style.display = c>0?'flex':'none';
        }

        // CART LOGIC UPDATED FOR PROMO LIMIT
        window.openCartModal = function() {
            const b = document.getElementById('cartBody');
            b.innerHTML = '';
            let total = 0;

            if(window.cart.length === 0) {
                b.innerHTML = `<div class="text-center py-5 text-muted opacity-50">Cart is empty</div>`;
            } else {
                window.cart.forEach((it,i) => {
                    // DYNAMIC PRICE CALCULATION
                    let finalPrice = it.price;
                    let isPromo = false;
                    let promoMsg = "";

                    if(it.promo > 0 && it.qty >= 5) {
                        finalPrice = it.promo;
                        isPromo = true;
                    } else if (it.promo > 0 && it.qty < 5) {
                        // Hint to user
                        const need = 5 - it.qty;
                        promoMsg = `<span class="promo-hint"><i class="bi bi-tag"></i> Add ${need} more for ${currencyUnit}${it.promo}</span>`;
                    }

                    const itemTotal = finalPrice * it.qty;
                    total += itemTotal;
                    
                    const priceClass = isPromo ? "text-danger fw-bold" : "text-dark fw-bold";
                    const priceLabel = isPromo ? "PROMO PRICE" : "";

                    b.innerHTML += `
                    <div class="card mb-2 border-0 shadow-sm">
                        <div class="card-body p-3 d-flex justify-content-between align-items-center">
                            <div style="width:55%">
                                <div class="fw-bold text-dark">${it.code}</div>
                                <div class="small text-truncate text-muted">${it.name}</div>
                                <div class="${priceClass} mt-1">${currencyUnit}${finalPrice} <span style="font-size:0.6rem; color:#dc3545;">${priceLabel}</span></div>
                                ${promoMsg}
                            </div>
                            
                            <div class="text-end">
                                <div class="qty-control mb-2 justify-content-end">
                                    <button class="qty-btn p-0" onclick="window.changeCartQty(${i}, -1)">-</button>
                                    <span class="mx-2 fw-bold">${it.qty}</span>
                                    <button class="qty-btn p-0" onclick="window.changeCartQty(${i}, 1)">+</button>
                                </div>
                                <small class="text-danger fw-bold cursor-pointer" onclick="window.remCart(${i})">REMOVE</small>
                            </div>
                        </div>
                    </div>`;
                });
            }
            document.getElementById('cartTotal').innerText = currencyUnit + total;
            document.getElementById('limitWarning').style.display = total > orderLimit ? 'block':'none';
            window.cartModal.show();
        }

        window.changeCartQty = function(i, d) {
            const cItem = window.cart[i];
            const dbItem = window.fullDatabase.find(x=>x.code === cItem.code);
            let n = cItem.qty + d;
            if(n < 1) return;
            if(n > dbItem.stock) return alert("Stock Limit");
            cItem.qty = n;
            window.openCartModal(); // Re-render to update price logic
            updateCartBadge();
        }

        window.remCart = function(i) {
            window.cart.splice(i, 1);
            window.openCartModal();
            updateCartBadge();
        }

        window.confirmOrder = function() {
            if(window.cart.length===0) return alert("Empty Cart");
            
            // Calculate Final Total again for validation
            let t = 0;
            const finalCart = window.cart.map(it => {
                let price = it.price;
                if(it.promo > 0 && it.qty >= 5) price = it.promo;
                t += price * it.qty;
                return { ...it, finalPrice: price };
            });

            if(t > orderLimit) return alert("Over 100,000 Limit");
            
            // Local deduct
            window.cart.forEach(c => {
                let d = window.fullDatabase.find(x=>x.code === c.code);
                if(d) d.stock = Math.max(0, d.stock - c.qty);
            });

            let m = `ðŸ›’ *ORDER (${window.loggedInUser.name})*\n`;
            finalCart.forEach(x => {
                m += `â–ª ${x.code} (x${x.qty}) @ ${x.finalPrice}\n`;
            });
            m += `\n*TOTAL: ${t}*`;
            
            window.open(`https://wa.me/${myWhatsAppNumber}?text=${encodeURIComponent(m)}`, '_blank');
            
            window.cart=[]; 
            updateCartBadge(); 
            window.cartModal.hide();
            window.handleSearch();
        }

        window.downloadCSV = function() {
             if(window.cart.length===0) return alert("Empty");
             let c = "Client,Code,Qty,FinalPrice,Total\n";
             window.cart.forEach(x => {
                 let p = x.price;
                 if(x.promo > 0 && x.qty >= 5) p = x.promo;
                 c+=`${window.loggedInUser.name},${x.code},${x.qty},${p},${p*x.qty}\n`
             });
             const a = document.createElement('a');
             a.href = 'data:text/csv;charset=utf-8,' + encodeURI(c);
             a.download = 'order.csv';
             a.click();
        }
        
        document.getElementById('loginPass').addEventListener('keypress', (e)=>{
            if(e.key==='Enter') window.attemptLogin();
        });
    </script>
</body>
</html>